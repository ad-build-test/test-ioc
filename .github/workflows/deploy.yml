name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      facility:
        description: >
          Deployment facility Deploy only to the specified facility(s). Put 'ALL'
          for all facilities. | Options: [dev, lcls, facet,
          testfac] Seperate facilties by comma, ex: dev,lcls
        required: true
        type: string
      tag:
        description: 'Docker/Git tag to deploy'
        required: true
        type: string

jobs:
  create-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: '${{ github.event.inputs.tag }}',
              environment: '${{ github.event.inputs.facility }}',
              required_contexts: [],
              auto_merge: false,
              payload: {
                facility: '${{ github.event.inputs.facility }}',
                tag: '${{ github.event.inputs.tag }}'
              },
              description: 'Deploying ${{ github.event.inputs.tag }} to ${{ github.event.inputs.facility }}'
            });
            
            console.log('Deployment created:', deployment.data.id);
            return deployment.data.id;
            
      - name: Set deployment status to in_progress
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'in_progress',
              description: 'Deployment webhook sent to backend',
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });
